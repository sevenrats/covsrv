<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Coverage Dashboard</title>
    <style>
      :root {
        --chart-h: 360px;
      }

      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 0;
        padding: 0;
        width: 100%;
        box-sizing: border-box;
      }

      .navbar {
        display: flex;
        align-items: center;
        padding: 8px 16px;
        gap: 10px;
        background: #fafafa;
        border-bottom: 1px solid #e2e2e2;
      }

      .nav-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid #e2e2e2;
        background: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        color: #333;
        transition: all 0.15s ease;
      }

      .nav-btn:hover {
        background: #f0f0f0;
        border-color: #d0d0d0;
      }

      .nav-btn svg {
        width: 18px;
        height: 18px;
      }

      .nav-spacer { flex: 1; }

      .logout-wrap {
        position: relative;
      }

      .logout-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 40px;
        background: white;
        border: 1px solid #e2e2e2;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        min-width: 180px;
        z-index: 100;
        padding: 4px 0;
      }

      .logout-menu.open { display: block; }

      .logout-menu a {
        display: block;
        padding: 8px 14px;
        font-size: 13px;
        color: #333;
        text-decoration: none;
        white-space: nowrap;
      }

      .logout-menu a:hover {
        background: #f5f5f5;
      }

      .logout-menu .sep {
        border-top: 1px solid #e8e8e8;
        margin: 4px 0;
      }

      .content {
        padding: 24px 40px;
      }

      .top {
        display:flex;
        gap:16px;
        align-items:baseline;
        flex-wrap:wrap;
      }

      .pill {
        padding:6px 12px;
        border-radius:999px;
        background:#f2f2f2;
        font-size:14px;
      }

      /* Muted text + buttons row */
      .muted-row {
        margin-top:8px;
        display:flex;
        flex-wrap:wrap;
        align-items:flex-end; /* bottom-align buttons with text */
        gap:14px;
        color:#666;
        font-size:14px;
      }

      a { color:inherit; text-decoration: underline; }

      .btn {
        padding:4px 10px;        /* shorter */
        border-radius:6px;
        border:1px solid #e2e2e2;
        background:#fafafa;
        font-size:12px;          /* slightly smaller */
        line-height:1.2;
        text-decoration:none;
        transition:all 0.15s ease;
        color:#333;
      }

      .btn:hover {
        background:#f0f0f0;
        border-color:#d0d0d0;
      }

      .grid {
        display:grid;
        grid-template-columns:1fr;
        gap:24px;
        margin-top:24px;
      }

      @media (min-width: 1000px) {
        .grid {
          grid-template-columns: 1fr 1fr;
          align-items: stretch;
        }
      }

      .card {
        border:1px solid #e7e7e7;
        border-radius:18px;
        padding:20px;
        background:white;
        box-shadow:0 1px 2px rgba(0,0,0,0.03);
      }

      .card h2 {
        margin:0 0 16px 0;
        font-size:18px;
      }

      .chart-box {
        height: var(--chart-h);
      }

      .chart-box canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
      }

      #uncoveredList {
        margin-top:16px;
        padding-left:20px;
        max-height:160px;
        overflow-y:auto;
        font-size:14px;
      }
    </style>
  </head>

  <body>
    <nav class="navbar">
      <a class="nav-btn" href="{{ back_url }}" title="Back">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
      </a>
      <a class="nav-btn" id="spreadsheetBtn" href="{{ raw_framed_url if raw_framed_url else '#' }}" title="Report"{% if not raw_framed_url %} style="display:none"{% endif %}>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
      </a>
      <a class="nav-btn" href="{{ github_url }}" title="Repository">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.009-.866-.013-1.7-2.782.604-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/></svg>
      </a>
      {% if logged_in_providers %}
      <span class="nav-spacer"></span>
      <div class="logout-wrap">
        <button class="nav-btn" id="logoutBtn" title="Logout" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </button>
        <div class="logout-menu" id="logoutMenu">
          {% for p in logged_in_providers %}
          <a href="/auth/{{ p.provider }}/logout?next={{ request_path | default('/', true) }}">{{ p.provider }} ({{ p.username }})</a>
          {% endfor %}
          {% if logged_in_providers | length > 1 %}
          <div class="sep"></div>
          {% endif %}
          <a href="/auth/logout?next={{ request_path | default('/', true) }}">Log out of all</a>
        </div>
      </div>
      {% endif %}
    </nav>
    <div class="content">
    <div class="top">
      <h1 style="margin:0;">Coverage</h1>
      <span class="pill" id="latestMeta">Loading latest…</span>
    </div>

    <div class="muted-row">
      <span>
        Uncovered-lines are from the latest report for this ref. Trend is historical.
      </span>

      <a class="btn" href="/download/json{{ download_suffix }}">JSON</a>
      <a class="btn" href="/download/lcov{{ download_suffix }}">LCOV</a>
      <a class="btn" href="/download/xml{{ download_suffix }}">XML</a>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Overall coverage trend</h2>
        <div class="chart-box"><canvas id="trendChart"></canvas></div>
      </div>

      <div class="card">
        <h2>Uncovered lines by file (latest)</h2>
        <div class="chart-box"><canvas id="uncoveredPie"></canvas></div>
        <ol id="uncoveredList"></ol>
      </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      async function loadTrend() {
        const res = await fetch("{{ trend_url }}?limit={{ trend_limit }}");
        return await res.json();
      }

      async function loadUncovered() {
        const res = await fetch("{{ uncovered_url }}?limit={{ pie_limit }}");
        return await res.json();
      }

      function tsToLabel(ts) {
        const d = new Date(ts * 1000);
        return d.toLocaleString();
      }

      function shorten(path) {
        if (!path) return path;
        if (path.length <= 40) return path;
        return "…" + path.slice(path.length - 39);
      }

      (async function main() {
        const [trend, uncovered] = await Promise.all([loadTrend(), loadUncovered()]);

        const meta = document.getElementById("latestMeta");
        const latest = uncovered && uncovered.latest ? uncovered.latest : null;

        if (latest) {
          const rawUrl = "{{ raw_url }}" + latest.git_hash;
          meta.innerHTML =
            `Latest: ${latest.repo} @ ` +
            `<a href="${rawUrl}">${latest.git_hash}</a> · ` +
            `${latest.overall_percent.toFixed(2)}% · ` +
            `${tsToLabel(latest.received_ts)}`;
          const spreadsheetBtn = document.getElementById("spreadsheetBtn");
          if (spreadsheetBtn && spreadsheetBtn.style.display === "none") {
            spreadsheetBtn.href = rawUrl;
            spreadsheetBtn.style.display = "";
          }
        } else {
          meta.textContent = "No reports yet.";
        }

        const tlabels = (trend.points || []).map(p => tsToLabel(p.received_ts));
        const tvals = (trend.points || []).map(p => p.overall_percent);

        new Chart(document.getElementById("trendChart"), {
          type: "line",
          data: {
            labels: tlabels,
            datasets: [{ label: "Overall % covered", data: tvals, tension: 0.2 }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { min: 0, max: 100 } }
          }
        });

        const plabels = (uncovered.files || []).map(x => shorten(x.filename));
        const pvals = (uncovered.files || []).map(x => x.uncovered_lines);

        new Chart(document.getElementById("uncoveredPie"), {
          type: "pie",
          data: {
            labels: plabels,
            datasets: [{ label: "Uncovered lines", data: pvals }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });

        const ulist = document.getElementById("uncoveredList");
        ulist.innerHTML = "";
        (uncovered.files || []).forEach(x => {
          const li = document.createElement("li");
          li.textContent = `${x.filename} — ${x.uncovered_lines} lines`;
          ulist.appendChild(li);
        });
      })();
    </script>
    <script>
      (function() {
        var btn = document.getElementById("logoutBtn");
        var menu = document.getElementById("logoutMenu");
        if (!btn || !menu) return;
        btn.addEventListener("click", function(e) {
          e.stopPropagation();
          menu.classList.toggle("open");
        });
        document.addEventListener("click", function() {
          menu.classList.remove("open");
        });
      })();
    </script>
  </body>
</html>
